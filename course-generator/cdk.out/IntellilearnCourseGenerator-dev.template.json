{
 "Description": "Intellilearn Course Generator infrastructure for dev environment - Automated language course generation using Step Functions, Bedrock, and Lambda",
 "Resources": {
  "NotificationTopicEB7A0DF1": {
   "Type": "AWS::SNS::Topic",
   "Properties": {
    "DisplayName": "Intellilearn Course Generation Notifications",
    "FifoTopic": false,
    "Tags": [
     {
      "Key": "Component",
      "Value": "CourseGenerator"
     },
     {
      "Key": "Environment",
      "Value": "dev"
     },
     {
      "Key": "ManagedBy",
      "Value": "CDK"
     },
     {
      "Key": "Owner",
      "Value": "TelmoAI"
     },
     {
      "Key": "Project",
      "Value": "Intellilearn"
     }
    ],
    "TopicName": "intellilearn-course-notifications"
   },
   "Metadata": {
    "aws:cdk:path": "IntellilearnCourseGenerator-dev/NotificationTopic/Resource"
   }
  },
  "CompletionHandlerLogGroupF70CB6BD": {
   "Type": "AWS::Logs::LogGroup",
   "Properties": {
    "LogGroupName": "/aws/lambda/intellilearn-course-completion-handler",
    "RetentionInDays": 30,
    "Tags": [
     {
      "Key": "Component",
      "Value": "CourseGenerator"
     },
     {
      "Key": "Environment",
      "Value": "dev"
     },
     {
      "Key": "ManagedBy",
      "Value": "CDK"
     },
     {
      "Key": "Owner",
      "Value": "TelmoAI"
     },
     {
      "Key": "Project",
      "Value": "Intellilearn"
     }
    ]
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "IntellilearnCourseGenerator-dev/CompletionHandlerLogGroup/Resource"
   }
  },
  "CompletionHandlerServiceRole4FF366C3": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ],
    "Tags": [
     {
      "Key": "Component",
      "Value": "CourseGenerator"
     },
     {
      "Key": "Environment",
      "Value": "dev"
     },
     {
      "Key": "ManagedBy",
      "Value": "CDK"
     },
     {
      "Key": "Owner",
      "Value": "TelmoAI"
     },
     {
      "Key": "Project",
      "Value": "Intellilearn"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "IntellilearnCourseGenerator-dev/CompletionHandler/ServiceRole/Resource"
   }
  },
  "CompletionHandlerServiceRoleDefaultPolicyD3D1CB3B": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "dynamodb:BatchGetItem",
        "dynamodb:BatchWriteItem",
        "dynamodb:ConditionCheckItem",
        "dynamodb:DeleteItem",
        "dynamodb:DescribeTable",
        "dynamodb:GetItem",
        "dynamodb:GetRecords",
        "dynamodb:GetShardIterator",
        "dynamodb:PutItem",
        "dynamodb:Query",
        "dynamodb:Scan",
        "dynamodb:UpdateItem"
       ],
       "Effect": "Allow",
       "Resource": [
        "arn:aws:dynamodb:us-east-1:076276934311:table/intellilearn-data-prod",
        {
         "Ref": "AWS::NoValue"
        }
       ]
      },
      {
       "Action": "sns:Publish",
       "Effect": "Allow",
       "Resource": {
        "Ref": "NotificationTopicEB7A0DF1"
       }
      },
      {
       "Action": [
        "bedrock:InvokeModel",
        "bedrock:InvokeModelWithResponseStream"
       ],
       "Effect": "Allow",
       "Resource": [
        "arn:aws:bedrock:us-east-1::foundation-model/amazon.titan-embed-text-v1",
        "arn:aws:bedrock:us-east-1::foundation-model/amazon.titan-text-express-v1"
       ]
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "CompletionHandlerServiceRoleDefaultPolicyD3D1CB3B",
    "Roles": [
     {
      "Ref": "CompletionHandlerServiceRole4FF366C3"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "IntellilearnCourseGenerator-dev/CompletionHandler/ServiceRole/DefaultPolicy/Resource"
   }
  },
  "CompletionHandler505A1FB8": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "S3Bucket": "cdk-hnb659fds-assets-076276934311-us-east-1",
     "S3Key": "e37c0d9a6bb51278d4bb117ddc6054166144b404963da8aa35a8be8385961877.zip"
    },
    "Environment": {
     "Variables": {
      "COURSE_TABLE_NAME": "intellilearn-data-prod",
      "SNS_TOPIC_ARN": {
       "Ref": "NotificationTopicEB7A0DF1"
      },
      "ENVIRONMENT": "dev",
      "ACCOUNT_ID": "076276934311"
     }
    },
    "FunctionName": "intellilearn-course-completion-handler",
    "Handler": "course-completion-handler.lambda_handler",
    "LoggingConfig": {
     "LogGroup": {
      "Ref": "CompletionHandlerLogGroupF70CB6BD"
     }
    },
    "MemorySize": 512,
    "Role": {
     "Fn::GetAtt": [
      "CompletionHandlerServiceRole4FF366C3",
      "Arn"
     ]
    },
    "Runtime": "python3.11",
    "Tags": [
     {
      "Key": "Component",
      "Value": "CourseGenerator"
     },
     {
      "Key": "Environment",
      "Value": "dev"
     },
     {
      "Key": "ManagedBy",
      "Value": "CDK"
     },
     {
      "Key": "Owner",
      "Value": "TelmoAI"
     },
     {
      "Key": "Project",
      "Value": "Intellilearn"
     }
    ],
    "Timeout": 300
   },
   "DependsOn": [
    "CompletionHandlerServiceRoleDefaultPolicyD3D1CB3B",
    "CompletionHandlerServiceRole4FF366C3"
   ],
   "Metadata": {
    "aws:cdk:path": "IntellilearnCourseGenerator-dev/CompletionHandler/Resource",
    "aws:asset:path": "asset.e37c0d9a6bb51278d4bb117ddc6054166144b404963da8aa35a8be8385961877",
    "aws:asset:is-bundled": false,
    "aws:asset:property": "Code"
   }
  },
  "StepFunctionsRole575CBBE2": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "states.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "Description": "IAM role for Intellilearn Course Generator Step Functions",
    "Policies": [
     {
      "PolicyDocument": {
       "Statement": [
        {
         "Action": [
          "logs:CreateLogGroup",
          "logs:CreateLogStream",
          "logs:DescribeLogGroups",
          "logs:DescribeLogStreams",
          "logs:PutLogEvents"
         ],
         "Effect": "Allow",
         "Resource": "*"
        }
       ],
       "Version": "2012-10-17"
      },
      "PolicyName": "StepFunctionsBasic"
     },
     {
      "PolicyDocument": {
       "Statement": [
        {
         "Action": [
          "bedrock:InvokeModel",
          "bedrock:InvokeModelWithResponseStream"
         ],
         "Effect": "Allow",
         "Resource": [
          "arn:aws:bedrock:us-east-1::foundation-model/amazon.titan-embed-text-v1",
          "arn:aws:bedrock:us-east-1::foundation-model/anthropic.claude-3-sonnet-20240229-v1:0"
         ]
        }
       ],
       "Version": "2012-10-17"
      },
      "PolicyName": "BedrockAccess"
     },
     {
      "PolicyDocument": {
       "Statement": [
        {
         "Action": [
          "s3:GetObject",
          "s3:PutObject",
          "s3:PutObjectAcl"
         ],
         "Effect": "Allow",
         "Resource": [
          "arn:aws:s3:::intellilearn-courses-dev/*",
          "arn:aws:s3:::intellilearn-vectors-076276934311/*"
         ]
        }
       ],
       "Version": "2012-10-17"
      },
      "PolicyName": "S3Access"
     },
     {
      "PolicyDocument": {
       "Statement": [
        {
         "Action": "lambda:InvokeFunction",
         "Effect": "Allow",
         "Resource": {
          "Fn::GetAtt": [
           "CompletionHandler505A1FB8",
           "Arn"
          ]
         }
        }
       ],
       "Version": "2012-10-17"
      },
      "PolicyName": "LambdaAccess"
     }
    ],
    "Tags": [
     {
      "Key": "Component",
      "Value": "CourseGenerator"
     },
     {
      "Key": "Environment",
      "Value": "dev"
     },
     {
      "Key": "ManagedBy",
      "Value": "CDK"
     },
     {
      "Key": "Owner",
      "Value": "TelmoAI"
     },
     {
      "Key": "Project",
      "Value": "Intellilearn"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "IntellilearnCourseGenerator-dev/StepFunctionsRole/Resource"
   }
  },
  "StepFunctionsRoleDefaultPolicy14E0B433": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "logs:CreateLogDelivery",
        "logs:DeleteLogDelivery",
        "logs:DescribeLogGroups",
        "logs:DescribeResourcePolicies",
        "logs:GetLogDelivery",
        "logs:ListLogDeliveries",
        "logs:PutResourcePolicy",
        "logs:UpdateLogDelivery",
        "xray:GetSamplingRules",
        "xray:GetSamplingTargets",
        "xray:PutTelemetryRecords",
        "xray:PutTraceSegments"
       ],
       "Effect": "Allow",
       "Resource": "*"
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "StepFunctionsRoleDefaultPolicy14E0B433",
    "Roles": [
     {
      "Ref": "StepFunctionsRole575CBBE2"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "IntellilearnCourseGenerator-dev/StepFunctionsRole/DefaultPolicy/Resource"
   }
  },
  "StateMachineLogGroup15B91BCB": {
   "Type": "AWS::Logs::LogGroup",
   "Properties": {
    "LogGroupName": "/aws/stepfunctions/intellilearn-course-generator",
    "RetentionInDays": 30,
    "Tags": [
     {
      "Key": "Component",
      "Value": "CourseGenerator"
     },
     {
      "Key": "Environment",
      "Value": "dev"
     },
     {
      "Key": "ManagedBy",
      "Value": "CDK"
     },
     {
      "Key": "Owner",
      "Value": "TelmoAI"
     },
     {
      "Key": "Project",
      "Value": "Intellilearn"
     }
    ]
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "IntellilearnCourseGenerator-dev/StateMachineLogGroup/Resource"
   }
  },
  "CourseGeneratorStateMachine11CB5211": {
   "Type": "AWS::StepFunctions::StateMachine",
   "Properties": {
    "DefinitionString": {
     "Fn::Join": [
      "",
      [
       "{\"Comment\":\"üéì Intellilearn Course Generator - Working version with proper JSONPath\",\"StartAt\":\"PreparePrompts\",\"States\":{\"PreparePrompts\":{\"Type\":\"Pass\",\"Comment\":\"üìù Prepare course generation parameters\",\"Parameters\":{\"language.$\":\"$.language\",\"level.$\":\"$.level\",\"courseType.$\":\"$.courseType\",\"duration.$\":\"$.duration\",\"metadata\":{\"courseId.$\":\"$$.Execution.Name\",\"createdAt.$\":\"$$.State.EnteredTime\",\"platform\":\"Intellilearn\"},\"step\":1,\"totalSteps\":4,\"results\":[]},\"Next\":\"GenerateOutline\"},\"GenerateOutline\":{\"Type\":\"Task\",\"Comment\":\"üéØ Generate course outline\",\"Resource\":\"arn:aws:states:::lambda:invoke\",\"Parameters\":{\"FunctionName\":\"",
       {
        "Ref": "CompletionHandler505A1FB8"
       },
       "\",\"Payload\":{\"action\":\"generate_content\",\"language.$\":\"$.language\",\"level.$\":\"$.level\",\"courseType.$\":\"$.courseType\",\"duration.$\":\"$.duration\",\"currentRole\":\"Course Planner\",\"prompt\":\"Create a comprehensive course outline for this language and level with CEFR-aligned objectives, modules, and assessment strategy.\"}},\"ResultPath\":\"$.outlineResult\",\"Next\":\"GenerateCurriculum\",\"Retry\":[{\"ErrorEquals\":[\"States.TaskFailed\"],\"IntervalSeconds\":2,\"MaxAttempts\":3,\"BackoffRate\":2}]},\"GenerateCurriculum\":{\"Type\":\"Task\",\"Comment\":\"üìö Generate curriculum content\",\"Resource\":\"arn:aws:states:::lambda:invoke\",\"Parameters\":{\"FunctionName\":\"",
       {
        "Ref": "CompletionHandler505A1FB8"
       },
       "\",\"Payload\":{\"action\":\"generate_content\",\"language.$\":\"$.language\",\"level.$\":\"$.level\",\"courseType.$\":\"$.courseType\",\"duration.$\":\"$.duration\",\"currentRole\":\"Curriculum Designer\",\"prompt\":\"Develop detailed curriculum content for the first 3 modules with lesson plans, grammar, vocabulary, and cultural insights.\"}},\"ResultPath\":\"$.curriculumResult\",\"Next\":\"GenerateExercises\"},\"GenerateExercises\":{\"Type\":\"Task\",\"Comment\":\"üèãÔ∏è Generate practice exercises\",\"Resource\":\"arn:aws:states:::lambda:invoke\",\"Parameters\":{\"FunctionName\":\"",
       {
        "Ref": "CompletionHandler505A1FB8"
       },
       "\",\"Payload\":{\"action\":\"generate_content\",\"language.$\":\"$.language\",\"level.$\":\"$.level\",\"courseType.$\":\"$.courseType\",\"duration.$\":\"$.duration\",\"currentRole\":\"Exercise Designer\",\"prompt\":\"Design practice exercises including multiple choice, conversations for voice AI, and listening activities with answer keys.\"}},\"ResultPath\":\"$.exercisesResult\",\"Next\":\"GenerateAssessments\"},\"GenerateAssessments\":{\"Type\":\"Task\",\"Comment\":\"üìä Generate assessment methods\",\"Resource\":\"arn:aws:states:::lambda:invoke\",\"Parameters\":{\"FunctionName\":\"",
       {
        "Ref": "CompletionHandler505A1FB8"
       },
       "\",\"Payload\":{\"action\":\"generate_content\",\"language.$\":\"$.language\",\"level.$\":\"$.level\",\"courseType.$\":\"$.courseType\",\"duration.$\":\"$.duration\",\"currentRole\":\"Assessment Specialist\",\"prompt\":\"Create evaluation methods with diagnostic assessments, quizzes, and voice pronunciation criteria aligned with CEFR standards.\"}},\"ResultPath\":\"$.assessmentsResult\",\"Next\":\"ProcessFinalContent\"},\"ProcessFinalContent\":{\"Type\":\"Pass\",\"Comment\":\"üéØ Prepare final course content\",\"Parameters\":{\"language.$\":\"$.language\",\"level.$\":\"$.level\",\"courseType.$\":\"$.courseType\",\"duration.$\":\"$.duration\",\"metadata.$\":\"$.metadata\",\"outline.$\":\"$.outlineResult.Payload\",\"curriculum.$\":\"$.curriculumResult.Payload\",\"exercises.$\":\"$.exercisesResult.Payload\",\"assessments.$\":\"$.assessmentsResult.Payload\",\"status\":\"content_generated\"},\"Next\":\"StoreCourseContent\"},\"StoreCourseContent\":{\"Type\":\"Task\",\"Comment\":\"üíæ Store course content to S3\",\"Resource\":\"arn:aws:states:::aws-sdk:s3:putObject\",\"Parameters\":{\"Bucket\":\"intellilearn-courses-dev\",\"Key.$\":\"States.Format('courses/{}/{}/course-{}-{}.json', $.language, $.level, $.language, $.level)\",\"Body.$\":\"States.JsonToString($)\",\"ContentType\":\"application/json\"},\"ResultPath\":\"$.s3Result\",\"Next\":\"NotifyCompletion\"},\"NotifyCompletion\":{\"Type\":\"Task\",\"Comment\":\"üìß Send completion notification\",\"Resource\":\"arn:aws:states:::lambda:invoke\",\"Parameters\":{\"FunctionName\":\"",
       {
        "Ref": "CompletionHandler505A1FB8"
       },
       "\",\"Payload\":{\"action\":\"notify_completion\",\"courseId.$\":\"$.metadata.courseId\",\"language.$\":\"$.language\",\"level.$\":\"$.level\",\"s3Location.$\":\"$.s3Result.Key\",\"status\":\"completed\"}},\"ResultPath\":\"$.notificationResult\",\"Next\":\"Success\"},\"Success\":{\"Type\":\"Pass\",\"Comment\":\"‚úÖ Course generation completed successfully\",\"Parameters\":{\"status\":\"SUCCESS\",\"message\":\"Course generated successfully\",\"courseId.$\":\"$.metadata.courseId\",\"language.$\":\"$.language\",\"level.$\":\"$.level\",\"s3Location.$\":\"$.s3Result.Key\",\"generatedAt.$\":\"$.metadata.createdAt\"},\"End\":true}}}"
      ]
     ]
    },
    "LoggingConfiguration": {
     "Destinations": [
      {
       "CloudWatchLogsLogGroup": {
        "LogGroupArn": {
         "Fn::GetAtt": [
          "StateMachineLogGroup15B91BCB",
          "Arn"
         ]
        }
       }
      }
     ],
     "IncludeExecutionData": true,
     "Level": "ALL"
    },
    "RoleArn": {
     "Fn::GetAtt": [
      "StepFunctionsRole575CBBE2",
      "Arn"
     ]
    },
    "StateMachineName": "intellilearn-course-generator",
    "Tags": [
     {
      "Key": "Component",
      "Value": "CourseGenerator"
     },
     {
      "Key": "Environment",
      "Value": "dev"
     },
     {
      "Key": "ManagedBy",
      "Value": "CDK"
     },
     {
      "Key": "Owner",
      "Value": "TelmoAI"
     },
     {
      "Key": "Project",
      "Value": "Intellilearn"
     }
    ],
    "TracingConfiguration": {
     "Enabled": true
    }
   },
   "DependsOn": [
    "StepFunctionsRoleDefaultPolicy14E0B433",
    "StepFunctionsRole575CBBE2"
   ],
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "IntellilearnCourseGenerator-dev/CourseGeneratorStateMachine/Resource"
   }
  },
  "VisualStepFunctionsRole163148C8": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "states.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "Description": "IAM role for Intellilearn Visual Course Generator Step Functions with Bedrock access",
    "Policies": [
     {
      "PolicyDocument": {
       "Statement": [
        {
         "Action": [
          "bedrock:InvokeModel",
          "bedrock:InvokeModelWithResponseStream"
         ],
         "Effect": "Allow",
         "Resource": [
          "arn:aws:bedrock:us-east-1::foundation-model/amazon.titan-embed-text-v1",
          "arn:aws:bedrock:us-east-1::foundation-model/amazon.titan-text-express-v1"
         ]
        }
       ],
       "Version": "2012-10-17"
      },
      "PolicyName": "BedrockAccess"
     },
     {
      "PolicyDocument": {
       "Statement": [
        {
         "Action": [
          "s3:GetObject",
          "s3:PutObject",
          "s3:PutObjectAcl"
         ],
         "Effect": "Allow",
         "Resource": [
          "arn:aws:s3:::intellilearn-courses-dev/*",
          "arn:aws:s3:::intellilearn-vectors-076276934311/*"
         ]
        }
       ],
       "Version": "2012-10-17"
      },
      "PolicyName": "S3Access"
     },
     {
      "PolicyDocument": {
       "Statement": [
        {
         "Action": "lambda:InvokeFunction",
         "Effect": "Allow",
         "Resource": {
          "Fn::GetAtt": [
           "CompletionHandler505A1FB8",
           "Arn"
          ]
         }
        }
       ],
       "Version": "2012-10-17"
      },
      "PolicyName": "LambdaAccess"
     },
     {
      "PolicyDocument": {
       "Statement": [
        {
         "Action": [
          "logs:CreateLogGroup",
          "logs:CreateLogStream",
          "logs:PutLogEvents"
         ],
         "Effect": "Allow",
         "Resource": "*"
        }
       ],
       "Version": "2012-10-17"
      },
      "PolicyName": "LogsAccess"
     }
    ],
    "Tags": [
     {
      "Key": "Component",
      "Value": "CourseGenerator"
     },
     {
      "Key": "Environment",
      "Value": "dev"
     },
     {
      "Key": "ManagedBy",
      "Value": "CDK"
     },
     {
      "Key": "Owner",
      "Value": "TelmoAI"
     },
     {
      "Key": "Project",
      "Value": "Intellilearn"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "IntellilearnCourseGenerator-dev/VisualStepFunctionsRole/Resource"
   }
  },
  "VisualStepFunctionsRoleDefaultPolicy996219FF": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "logs:CreateLogDelivery",
        "logs:DeleteLogDelivery",
        "logs:DescribeLogGroups",
        "logs:DescribeResourcePolicies",
        "logs:GetLogDelivery",
        "logs:ListLogDeliveries",
        "logs:PutResourcePolicy",
        "logs:UpdateLogDelivery",
        "xray:GetSamplingRules",
        "xray:GetSamplingTargets",
        "xray:PutTelemetryRecords",
        "xray:PutTraceSegments"
       ],
       "Effect": "Allow",
       "Resource": "*"
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "VisualStepFunctionsRoleDefaultPolicy996219FF",
    "Roles": [
     {
      "Ref": "VisualStepFunctionsRole163148C8"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "IntellilearnCourseGenerator-dev/VisualStepFunctionsRole/DefaultPolicy/Resource"
   }
  },
  "VisualStateMachineLogGroup9C89B7DC": {
   "Type": "AWS::Logs::LogGroup",
   "Properties": {
    "LogGroupName": "/aws/stepfunctions/intellilearn-visual-course-generator",
    "RetentionInDays": 30,
    "Tags": [
     {
      "Key": "Component",
      "Value": "CourseGenerator"
     },
     {
      "Key": "Environment",
      "Value": "dev"
     },
     {
      "Key": "ManagedBy",
      "Value": "CDK"
     },
     {
      "Key": "Owner",
      "Value": "TelmoAI"
     },
     {
      "Key": "Project",
      "Value": "Intellilearn"
     }
    ]
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "IntellilearnCourseGenerator-dev/VisualStateMachineLogGroup/Resource"
   }
  },
  "VisualCourseGeneratorStateMachine2C274842": {
   "Type": "AWS::StepFunctions::StateMachine",
   "Properties": {
    "DefinitionString": "{\"Comment\":\"üéì Intellilearn Visual Course Generator - Direct Bedrock Integration\",\"StartAt\":\"PreparePrompts\",\"States\":{\"PreparePrompts\":{\"Type\":\"Pass\",\"Comment\":\"üìù Prepare course generation parameters\",\"Parameters\":{\"language.$\":\"$.language\",\"level.$\":\"$.level\",\"courseType.$\":\"$.courseType\",\"duration.$\":\"$.duration\",\"metadata\":{\"courseId.$\":\"$$.Execution.Name\",\"createdAt.$\":\"$$.State.EnteredTime\",\"platform\":\"Intellilearn\"},\"currentStep\":1,\"totalSteps\":4,\"roles\":[\"Course Planner\",\"Curriculum Designer\",\"Exercise Designer\",\"Assessment Specialist\"],\"prompts\":[\"Create a comprehensive course outline with CEFR-aligned objectives, modules, and assessment strategy\",\"Develop detailed curriculum content for the first 3 modules with lesson plans, grammar, vocabulary, and cultural insights\",\"Design practice exercises including multiple choice, conversations for voice AI, and listening activities with answer keys\",\"Create evaluation methods with diagnostic assessments, quizzes, and voice pronunciation criteria aligned with CEFR standards\"],\"results\":{}},\"Next\":\"GenerateOutline\"},\"GenerateOutline\":{\"Type\":\"Task\",\"Comment\":\"üéØ Generate Course Outline using Bedrock\",\"Resource\":\"arn:aws:states:::bedrock:invokeModel\",\"Parameters\":{\"ModelId\":\"amazon.titan-text-express-v1\",\"Body\":{\"inputText\":\"You are an expert Course Planner for language education. Create a comprehensive course outline with CEFR-aligned objectives, modules, and assessment strategy. Provide a detailed, structured course outline that follows educational best practices and CEFR standards.\",\"textGenerationConfig\":{\"maxTokenCount\":4000,\"temperature\":0.7,\"topP\":0.9}}},\"ResultSelector\":{\"content.$\":\"$.Body.results[0].outputText\",\"role\":\"Course Planner\",\"timestamp.$\":\"$$.State.EnteredTime\"},\"ResultPath\":\"$.outlineResult\",\"Next\":\"GenerateCurriculum\",\"Retry\":[{\"ErrorEquals\":[\"States.TaskFailed\"],\"IntervalSeconds\":2,\"MaxAttempts\":3,\"BackoffRate\":2}],\"Catch\":[{\"ErrorEquals\":[\"States.ALL\"],\"Next\":\"HandleBedrockError\",\"ResultPath\":\"$.error\"}]},\"GenerateCurriculum\":{\"Type\":\"Task\",\"Comment\":\"üìö Generate Curriculum Content using Bedrock\",\"Resource\":\"arn:aws:states:::bedrock:invokeModel\",\"Parameters\":{\"ModelId\":\"amazon.titan-text-express-v1\",\"Body\":{\"inputText\":\"You are an expert Curriculum Designer specializing in language education. Develop detailed curriculum content for the first 3 modules with lesson plans, grammar, vocabulary, and cultural insights. Please provide comprehensive curriculum content with lesson plans, grammar explanations, vocabulary lists, and interactive activities.\",\"textGenerationConfig\":{\"maxTokenCount\":4000,\"temperature\":0.7,\"topP\":0.9}}},\"ResultSelector\":{\"content.$\":\"$.Body.results[0].outputText\",\"role\":\"Curriculum Designer\",\"timestamp.$\":\"$$.State.EnteredTime\"},\"ResultPath\":\"$.curriculumResult\",\"Next\":\"GenerateExercises\"},\"GenerateExercises\":{\"Type\":\"Task\",\"Comment\":\"üèãÔ∏è Generate Practice Exercises using Bedrock\",\"Resource\":\"arn:aws:states:::bedrock:invokeModel\",\"Parameters\":{\"ModelId\":\"amazon.titan-text-express-v1\",\"Body\":{\"inputText\":\"You are an expert Exercise Designer for language learning platforms. Design practice exercises including multiple choice, conversations for voice AI, and listening activities with answer keys. Please create varied exercises including multiple choice, fill-in-blank, voice practice scenarios for Nova Sonic AI, and answer keys.\",\"textGenerationConfig\":{\"maxTokenCount\":4000,\"temperature\":0.7,\"topP\":0.9}}},\"ResultSelector\":{\"content.$\":\"$.Body.results[0].outputText\",\"role\":\"Exercise Designer\",\"timestamp.$\":\"$$.State.EnteredTime\"},\"ResultPath\":\"$.exercisesResult\",\"Next\":\"GenerateAssessments\"},\"GenerateAssessments\":{\"Type\":\"Task\",\"Comment\":\"üìä Generate Assessment Methods using Bedrock\",\"Resource\":\"arn:aws:states:::bedrock:invokeModel\",\"Parameters\":{\"ModelId\":\"amazon.titan-text-express-v1\",\"Body\":{\"inputText\":\"You are an expert Assessment Specialist. Create evaluation methods with diagnostic assessments, quizzes, and voice pronunciation criteria aligned with CEFR standards. Please design diagnostic assessments, quizzes, voice pronunciation criteria for Nova Sonic AI, and CEFR-aligned evaluation rubrics.\",\"textGenerationConfig\":{\"maxTokenCount\":4000,\"temperature\":0.7,\"topP\":0.9}}},\"ResultSelector\":{\"content.$\":\"$.Body.results[0].outputText\",\"role\":\"Assessment Specialist\",\"timestamp.$\":\"$$.State.EnteredTime\"},\"ResultPath\":\"$.assessmentsResult\",\"Next\":\"GenerateEmbedding\"},\"GenerateEmbedding\":{\"Type\":\"Task\",\"Comment\":\"üß† Generate Course Embedding using Titan\",\"Resource\":\"arn:aws:states:::bedrock:invokeModel\",\"Parameters\":{\"ModelId\":\"amazon.titan-embed-text-v1\",\"Body\":{\"inputText\":\"Complete language course with outline, curriculum, exercises, and assessments for educational platform.\"}},\"ResultSelector\":{\"embedding.$\":\"$.Body.embedding\",\"timestamp.$\":\"$$.State.EnteredTime\"},\"ResultPath\":\"$.embeddingResult\",\"Next\":\"StoreCourseContent\"},\"StoreCourseContent\":{\"Type\":\"Task\",\"Comment\":\"üíæ Store Complete Course to S3\",\"Resource\":\"arn:aws:states:::aws-sdk:s3:putObject\",\"Parameters\":{\"Bucket\":\"intellilearn-courses-dev\",\"Key.$\":\"States.Format('courses/{}/{}/course-{}-{}-{}.json', $.language, $.level, $.language, $.level, States.ArrayGetItem(States.StringSplit($.metadata.createdAt, 'T'), 0))\",\"Body.$\":\"States.JsonToString($)\",\"ContentType\":\"application/json\",\"Metadata\":{\"Language.$\":\"$.language\",\"Level.$\":\"$.level\",\"CourseType.$\":\"$.courseType\",\"Duration.$\":\"States.JsonToString($.duration)\",\"CourseId.$\":\"$.metadata.courseId\",\"Platform\":\"Intellilearn\",\"GeneratedAt.$\":\"$.metadata.createdAt\"}},\"ResultPath\":\"$.s3Result\",\"Next\":\"StoreEmbedding\"},\"StoreEmbedding\":{\"Type\":\"Task\",\"Comment\":\"üîç Store Course Embedding to S3\",\"Resource\":\"arn:aws:states:::aws-sdk:s3:putObject\",\"Parameters\":{\"Bucket\":\"intellilearn-vectors-076276934311\",\"Key.$\":\"States.Format('embeddings/{}/{}/embedding-{}-{}-{}.json', $.language, $.level, $.language, $.level, States.ArrayGetItem(States.StringSplit($.metadata.createdAt, 'T'), 0))\",\"Body.$\":\"States.JsonToString($.embeddingResult)\",\"ContentType\":\"application/json\",\"Metadata\":{\"CourseId.$\":\"$.metadata.courseId\",\"Language.$\":\"$.language\",\"Level.$\":\"$.level\",\"EmbeddingModel\":\"amazon.titan-embed-text-v1\",\"GeneratedAt.$\":\"$.metadata.createdAt\"}},\"ResultPath\":\"$.embeddingS3Result\",\"Next\":\"NotifyCompletion\"},\"NotifyCompletion\":{\"Type\":\"Task\",\"Comment\":\"üìß Send Completion Notification\",\"Resource\":\"arn:aws:states:::lambda:invoke\",\"Parameters\":{\"FunctionName\":\"intellilearn-course-completion-handler\",\"Payload\":{\"action\":\"notify_completion\",\"courseId.$\":\"$.metadata.courseId\",\"language.$\":\"$.language\",\"level.$\":\"$.level\",\"courseType.$\":\"$.courseType\",\"duration.$\":\"$.duration\",\"s3Location.$\":\"$.s3Result.Key\",\"embeddingLocation.$\":\"$.embeddingS3Result.Key\",\"generatedAt.$\":\"$.metadata.createdAt\",\"status\":\"completed\",\"outline.$\":\"$.outlineResult\",\"curriculum.$\":\"$.curriculumResult\",\"exercises.$\":\"$.exercisesResult\",\"assessments.$\":\"$.assessmentsResult\"}},\"ResultPath\":\"$.notificationResult\",\"Next\":\"Success\"},\"Success\":{\"Type\":\"Pass\",\"Comment\":\"‚úÖ Course Generation Completed Successfully\",\"Parameters\":{\"status\":\"SUCCESS\",\"message\":\"Course generated successfully with direct Bedrock integration\",\"courseId.$\":\"$.metadata.courseId\",\"language.$\":\"$.language\",\"level.$\":\"$.level\",\"courseType.$\":\"$.courseType\",\"duration.$\":\"$.duration\",\"s3Location.$\":\"$.s3Result.Key\",\"embeddingLocation.$\":\"$.embeddingS3Result.Key\",\"generatedAt.$\":\"$.metadata.createdAt\",\"components\":{\"outline\":\"Generated by Course Planner\",\"curriculum\":\"Generated by Curriculum Designer\",\"exercises\":\"Generated by Exercise Designer\",\"assessments\":\"Generated by Assessment Specialist\"},\"models\":{\"textGeneration\":\"amazon.titan-text-express-v1\",\"embedding\":\"amazon.titan-embed-text-v1\"}},\"End\":true},\"HandleBedrockError\":{\"Type\":\"Pass\",\"Comment\":\"‚ùå Handle Bedrock Access Errors\",\"Parameters\":{\"status\":\"FAILED\",\"error\":\"Bedrock model access required\",\"details.$\":\"$.error\",\"language.$\":\"$.language\",\"level.$\":\"$.level\",\"message\":\"Please enable Amazon Titan models in Bedrock console\",\"helpUrl\":\"https://console.aws.amazon.com/bedrock/home#/modelaccess\",\"requiredModels\":[\"amazon.titan-text-express-v1\",\"amazon.titan-embed-text-v1\"]},\"Next\":\"Failure\"},\"Failure\":{\"Type\":\"Fail\",\"Comment\":\"üí• Course Generation Failed\",\"Cause\":\"Course generation process encountered an error. Check Bedrock model access.\"}}}",
    "LoggingConfiguration": {
     "Destinations": [
      {
       "CloudWatchLogsLogGroup": {
        "LogGroupArn": {
         "Fn::GetAtt": [
          "VisualStateMachineLogGroup9C89B7DC",
          "Arn"
         ]
        }
       }
      }
     ],
     "IncludeExecutionData": true,
     "Level": "ALL"
    },
    "RoleArn": {
     "Fn::GetAtt": [
      "VisualStepFunctionsRole163148C8",
      "Arn"
     ]
    },
    "StateMachineName": "intellilearn-visual-course-generator",
    "Tags": [
     {
      "Key": "Component",
      "Value": "VisualCourseGenerator"
     },
     {
      "Key": "Environment",
      "Value": "dev"
     },
     {
      "Key": "ManagedBy",
      "Value": "CDK"
     },
     {
      "Key": "Owner",
      "Value": "TelmoAI"
     },
     {
      "Key": "Project",
      "Value": "Intellilearn"
     }
    ],
    "TracingConfiguration": {
     "Enabled": true
    }
   },
   "DependsOn": [
    "VisualStepFunctionsRoleDefaultPolicy996219FF",
    "VisualStepFunctionsRole163148C8"
   ],
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "IntellilearnCourseGenerator-dev/VisualCourseGeneratorStateMachine/Resource"
   }
  }
 },
 "Parameters": {
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}